image: alpine:latest

before_script:
  - apk add --quiet openssh-client
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  - mkdir -p ~/.ssh && touch ~/.ssh/known_hosts
  - chmod 700 ~/.ssh
  - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts

deploy:
  script:
    # Deploy develop branch
    - ssh -o StrictHostKeyChecking=no knowledge@knowledge.msharks.ru "cd ~/knowledge.msharks.ru/frontend/ && git fetch --all && git reset --hard origin/develop && cd ../ && docker-compose up node"
  only:
    - develop


deploy:
  script:
    # Deploy release branch
    - ssh -o StrictHostKeyChecking=no kb_admin@knowledge.oktadi.ru "cd /var/www/knowledge/frontend/ && git fetch --all && git reset --hard origin/release && cp .env src/globals.js && npm install && npm run build"
  only:
    - release
